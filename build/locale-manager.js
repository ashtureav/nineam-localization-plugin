/*
LocaleManager Plugin 0.1.0

Copyright (c) 2013 [ninth avenue media, LLC] (mailto: paul.smith.iv@ninthavenuemedia.com)
Open source under the [MIT License](http://en.wikipedia.org/wiki/MIT_License).
*/
Ext.Class.registerPreprocessor("extendConfig",function(b,d,a,c){if(Ext.getVersion("extjs")){d.extend=d.extendConfig.extjs}else{d.extend=d.extendConfig.st}},false,"before","extend");Ext.Class.registerPreprocessor("modelConfig",function(b,d,a,c){var e;if(Ext.getVersion("extjs")){e=d}else{if(!d.config){d.config={}}e=d.config}e.fields=d.modelConfig},false,"before","extend");Ext.Class.registerPreprocessor("storeConfig",function(b,e,a,d){var f;if(Ext.getVersion("extjs")){f=e}else{if(!e.config){e.config={}}f=e.config}for(var c in e.storeConfig){f[c]=e.storeConfig[c]}if(Ext.getVersion("extjs")){Ext.exclude(e.model).require("*")}},false,"before","extend");Ext.define("nineam.localization.model.LocaleModel",{extend:"Ext.data.Model",modelConfig:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"url",type:"string"},{name:"propertiesClass",type:"string"}]});Ext.define("nineam.localization.store.LocalesStore",{extend:"Ext.data.Store",requires:["Ext.data.reader.Json"],storeConfig:{storeId:"localesStore",model:"nineam.localization.model.LocaleModel",proxy:{type:"memory",reader:{type:"json",root:""}}}});Ext.define("nineam.localization.util.Persistence",{singleton:true,LOCALE_COOKIE_ID:"nineam.localization.util.Persistence-ExtJS.LOCALE_COOKIE_ID_2",getLocale:function(){var b=new RegExp("(?:^|;)\\s?"+this.LOCALE_COOKIE_ID+"=(.*?)(?:;|$)","i");var a=document.cookie.match(b);var c=a?unescape(a[1]):null;Ext.log({level:"log"},"DEBUG: LocaleManager - Getting persisted locale id: "+c);return c},setLocale:function(a){Ext.log({level:"log"},"DEBUG: LocaleManager - Persisting locale id: "+a);document.cookie=this.LOCALE_COOKIE_ID+"="+escape(a)+"; expires="+new Date(new Date().getTime()+(1000*60*60*24*365)).toUTCString()}});Ext.define("nineam.localization.model.ClientModel",{extend:"Ext.data.Model",modelConfig:[{name:"client",type:"object"},{name:"method",type:"object"},{name:"key",type:"string"}]});Ext.define("nineam.localization.event.LocaleEvent",{statics:{INITIALIZED:"nineam.localization.event.LocaleEvent.INITIALIZED",LOCALES_CHANGED:"nineam.localization.event.LocaleEvent.LOCALES_CHANGED",LOCALE_LOADING:"nineam.localization.event.LocaleEvent.LOCALE_LOADING",LOCALE_CHANGED:"nineam.localization.event.LocaleEvent.LOCALE_CHANGED"}});Ext.define("nineam.localization.delegate.LocaleDelegate",{requires:["Ext.Ajax"],success:{},failure:{},scope:"",constructor:function(c,a,b){this.callParent(arguments);this.success=c;this.failure=a;this.scope=b},loadPropertiesFile:function(a){if(!this.success||!this.scope){return}Ext.Ajax.request({url:a,success:this.ajaxSuccess,failure:this.ajaxFailure,scope:this})},ajaxSuccess:function(a){this.success.call(this.scope,a.responseText)},ajaxFailure:function(){}});Ext.define("nineam.localization.LocaleManager",{singleton:true,mixins:{observable:"Ext.util.Observable"},initialized:false,clients:[],locales:null,getLocales:function(){return this.locales},setLocales:function(a){this.locales=a;this.fireEvent(nineam.localization.event.LocaleEvent.LOCALES_CHANGED,{})},locale:"",getLocale:function(){return this.locale},setLocale:function(a){this.fireEvent(nineam.localization.event.LocaleEvent.LOCALE_LOADING,{});this.locale=a;this.loadPropertiesFile()},properties:null,getProperty:function(key){return eval("this.properties."+key)},getPersistedLocale:function(){var a=nineam.localization.util.Persistence.getLocale();return this.locales.find("id",a)!=-1?a:this.locales.getAt(0).get("id")},constructor:function(a){if(typeof(Ext.log)!="function"){Ext.log=function(b,c){console.log(c)}}Ext.log({level:"log"},"DEBUG: Constructing LocaleManager");this.callParent(arguments);this.mixins.observable.constructor.call(this,a)},loadPropertiesFile:function(){var c=this.locales.findRecord("id",this.locale);var b=Ext.create("nineam.localization.delegate.LocaleDelegate",this.loadPropertiesFileResultHandler,this.loadPropertiesFileFaultHandler,this);var a=c.get("url");Ext.log({level:"log"},"DEBUG: LocaleManager - Loading properties file: "+a);b.loadPropertiesFile(a)},loadPropertiesFileResultHandler:function(a){Ext.log({level:"log"},"DEBUG: LocaleManager - Properties file loaded: "+this.locales.findRecord("id",this.locale).get("url"));var c=document.getElementsByTagName("head")[0];var b=document.createElement("script");b.type="text/javascript";b.innerHTML=a;c.appendChild(b);var d=this;setTimeout(function(){var e=d.locales.findRecord("id",d.locale);d.properties=Ext.create(e.get("propertiesClass"));d.updateClients();nineam.localization.util.Persistence.setLocale(d.locale);d.fireEvent(nineam.localization.event.LocaleEvent.LOCALE_CHANGED,{});if(!d.initialized){Ext.log({level:"log"},"DEBUG: LocaleManager - Locale Manager Initialized");d.initialized=true;d.fireEvent(nineam.localization.event.LocaleEvent.INITIALIZED,{})}},100)},loadPropertiesFileFaultHandler:function(){Ext.log({level:"error"},"ERROR: LocaleManager - Failure loading properties file")},updateClients:function(){Ext.log({level:"log"},"DEBUG: LocaleManager - Updating Clients");var a=this.clients.length-1;for(var b=a;b>-1;b--){this.updateClient(this.clients[b])}},updateClient:function(d){var a=d.get("client");var h=d.get("method");var b=d.get("key");try{var g;if(b){var c=this.getProperty(b);g=c?c:this.properties}else{g=this.properties}if(typeof(h)==="string"){a[h].call(a,g)}else{if(typeof(h)==="function"){h.call(a,g)}}}catch(f){Ext.log({level:"error"},"ERROR: LocaleManager - Error updating client [client: "+a.getId()+", method: "+h+", key: "+b+"] - error: "+f)}},registerClient:function(a){Ext.log({level:"log"},"DEBUG: LocaleManager - Registering client component [client: "+a.get("client").getId()+", method: "+a.get("method")+", key: "+a.get("key")+"]");this.clients.push(a);if(this.properties){this.updateClient(a)}}});Ext.define("nineam.localization.LocalePlugin",{extendConfig:{extjs:"Ext.AbstractPlugin",st:"Ext.Component"},alias:"plugin.localization",config:{method:{},key:""},init:function(b){var a=Ext.create("nineam.localization.model.ClientModel",{client:b,method:this.getMethod(),key:this.getKey()});nineam.localization.LocaleManager.registerClient(a)}});